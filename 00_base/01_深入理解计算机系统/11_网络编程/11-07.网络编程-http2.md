https://datatracker.ietf.org/doc/rfc7540/

### HTTP2

#### 0.概述

- http2是一种安全高效的http传输协议，安全是建立在https协议之上，高效是因为http2是通过二进制分帧来进行数据传输。

##### http2的特点：

- 1.对http1.x协议的兼容
  - http2协议是在1.x基础上的升级而不是重写，1.x协议的方法和api在http2协议里是一样的
- 2.性能的大幅提升

#### 1.二进制分帧 -- http2.0的基石

- 在二进制分帧层上，http2会将所有传输信息分割为更小的消息和帧，并对他们采用二进制格式的编码将其封装
  - 帧（frame）：帧包含类型type，长度length，标记flags，流标识stream和 frame payload有效载荷。
  - 消息（message）：消息是一个完整的请求或响应，比如请求，响应等，一个消息由一个或多个frame组成
  - http1.x中的首部信息header封装到了Headers帧中，而request body会被封装到data帧中

<img src=".\res7\1.http2二进制分帧.png" alt="1.http2二进制分帧" style="zoom:90%;" />

##### frame format 帧结构：

- 帧包含类型type，长度length，标记flags，流标识stream和 frame payload有效载荷。
- 流是连接中的一个虚拟信道，可以承载双向消息传输（客户端 <==>服务器端）。
  - 每个流都有唯一整数标识符，客户端发起的流使用奇数id，服务器端发起的流使用偶数id

<img src=".\res7\2.http2通信帧结构.png" alt="2.http2通信帧结构" style="zoom:100%;" />

#### 2.多路复用（Multiplexing）/连接共享

##### 2.1.http1.x连接数量限制

- 在http1.1中，浏览器客户端在同一时间，针对**同一域名下的请求有一定数量的限制**，超过限制数目的请求会被阻塞。
  - 这也是为何一些站点会有多个静态资源CDN域名的原因之一

##### 2.2.http2多路复用

- http2中的多路复用，允许在单一的http2连接下，发起多重的请求-响应消息。
- 有了新的分帧机制后，http2不再依赖多个TCP连接区实现多流并行了；每个数据流拆分成很多互不依赖的帧，这些帧可以交错（乱序发送），还可以分优先级，最后再在另一端把他们重新组合起来
- http2的连接都是持久化的，而且客户端与服务器之间只需要一个连接（每个域名一个连接）即可。多路复用意味着来自很多流的数据包能够混合在一起通过同样的连接进行传输。

<img src=".\res7\3.多个流数据在同一个连接下进行传输.png" alt="3.多个流数据在同一个连接下进行传输" style="zoom:100%;" />

同一连接下多个数据流进行传输

<img src=".\res7\4.http2多路复用.png" alt="4.http2多路复用" style="zoom:100%;" />

- 多个请求同时通信

#### 3.头部压缩

- http1.x的头贷由大量信息，而且每次都要重复发送。
- http2使用encoder来减少需要传输的header大小，通讯双方各自缓存一份头部字段表，即避免了重复header的传输，又减少了需要传输的大小。

##### http2采用HPACK算法进行压缩

- 使用header字段表里的索引代替实际的header

##### 4.http2所包含的帧类型

- **DATA**，用于传输`HTTP`消息体
- **HEADERS**，用于传输关于流的额外的首部字段（`Header`）
- **PRIORITY**，用于指定或者重新指定流的优先级
- **RST_STREAM**，用于通知流的非正常终止
- **SETTINGS**，用于通知两端通信方式的配置数据
- **PUSH_PROMISE**，用于发出创建流和服务器引用资源的要约
- **PING**，用于计算往返时间，执行“活性”检查
- **GOAWAY**，用于通知客户端/服务器停止在当前连接中创建流
- **WINDOW_UPDATE**，用于针对个别流或者个别连接实现流量控制
- **CONTINUATION**，用于继续一系列首部块片段













