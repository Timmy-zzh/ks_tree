### 传输层

- 传输层与网络层一起构成了网络协议层次的核心：
  - 网络层使用数据报或虚电路技术为端到端通信提供了数据包交付服务；
  - 传输层架构在网络层提供的服务之上，把数据传递服务从两台计算机之间扩展到两台计算机上的进程之间（不同程序的网络访问）；
  - 传输层为应用层使用网络提供了抽象的模式

#### 1.传输服务

- 传输层的用户通常是应用层的进程（不同的程序），通过**传输实体**完成

##### 1.1.传输层的设计目的

- 面向连接的传输服务与面向连接的网络服务类似，两者的连接都要经历三个阶段：**连接建立，数据传输和连接释放。**

###### 传输层服务和网络层服务如此相似，为什么还要设立两个独立的层呢？

- 用户对网络层没有真正的控制权，因为他们不拥有路由器。
- 当服务太差时，通过在网络层之上增加传输层来提高网络的服务质量。
  - 如果在一个无连接的网络中，数据包被丢失或发生错位，则传输实体可以检测到问题所在，并通过重传来弥补这种错误。
  - 如果在一个面向连接网络中，传输实体经过漫长等待，结果网络层连接被意外终止，则该传输实体可以建立一条新的网络层连接，利用新的连接，询问那些数据已经到达，那些数据没有到达，然后从中断的地方开始继续向对方发送数据。

**本质上：传输层使得传输服务有可能比网络服务更加可靠。**

- 网络可能会丢失数据包，所以网络服务一般来说是不可靠的，传输层的目标是在不可靠的网络之上提供可靠的服务

##### 1.2.传输服务原语

| 原语       | 发出的包         | 含义                           |
| ---------- | ---------------- | ------------------------------ |
| LISTEN     | (无)             | 阻塞，直到某个进程试图与之连接 |
| CONNECT    | CONNECTION REQ   | 主动尝试建立一个连接           |
| SEND       | DATA             | 发送信息                       |
| RECEIVE    | (无)             | 阻塞，直到到达一个DATA包       |
| DISCONNECT | DISCONECTION REQ | 请求释放连接                   |

##### 原语用法，假设一个应用，有一个服务器和多个远程客户

- 1.服务器执行LISTEN原语，调用一个库过程，**执行阻塞该服务器**的系统调用，直到有客户请求连接
- 2.当一个客户希望与服务器进行通话时，他就执行CONNECT原语
  - 传输实体阻塞调用方，然后给服务器发送一个包。
- 3.客户端的CONNECT调用导致传输实体发送一个connection request段给服务器。
  - 当该段到达服务器时，传输实体检查服务器是否阻塞在LISTEN状态（即服务器对处理请求感兴趣）。
  - 如果是，则解除服务器的阻塞，并给客户发送一个connection accepted段。当该段返回到客户端时，客户机的阻塞也被解除，于是连接被建立了起来
- 4.然后双方通过SEND和RECEIVE原语交换数据。
  - 任何一方都可以执行（阻塞的）RECEIVE原语，等待另一方执行SEND原语。
- 5.当不再需要一个连接时必须将它释放，终端有两种方式：非对称和对称的
  - 非对称方式中，然和一方都可以发送DISCONNECT原语，从而使他的传输实体将一个DISCONNECT段发送给远程的传输实体，当该段到达另一端时，连接就被释放了
  - 在对称方式中，当一方执行了DISCONNECT，这意味着他没有更多数据需要发送，但是他冷然愿意接收对方发送过来的数据。只有当双方都执行了DISCONNECT原语，一个连接才算真正被释放

##### 1.3.Berkeley套接字

- 即TCP所用的套接字（Socket）原语

| 原语    | 含义                           |
| ------- | ------------------------------ |
| SOCKET  | 创建一个新通信端点             |
| BIND    | 将套接字与一个本地地址关联     |
| LISTEN  | 声明愿意接受连接，给出队列长度 |
| ACCEPT  | 被动创建一个入境连接           |
| CONNECT | 主动创建一个连接               |
| SEND    | 通过连接发送一些数据           |
| RECEIVE | 从连接上接收一些数据           |
| CLOSE   | 释放连接                       |



##### 套接字编程实例

~~~java


~~~















