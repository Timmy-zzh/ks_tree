#### 1.CAS

在AQS的加锁和释放锁阶段，多次使用了一种通用操作：compareAndSetXXX.这种操作最终会调用Unsafe中的api进行CAS操作

- CAS全称是 Compare And Swap，意思为比较和替换，是一种通过硬件实现并发安全的常用技术
  - 底层通过利用CPU的CAS指令对缓存加锁或总线加锁的方式来实现多处理器之间的原子操作。

- CAS的实现过程主要有3个操作数：
  - 内存值V，旧的预期值E，要修改的新值U
  - 当且仅当预期值E和内存值V相同时，才将内存值V修改为U，否则什么都不做。



- CAS底层会根据操作系统和处理器的不同来选择对应的调用代码。
  - 以Windows和X86处理器为例，如果是多处理器，通过带lock前缀的cmpxchg指令对缓存加锁或总线加锁的方式来实现多处理器之间的原子操作
  - 如果是单处理器，通过cmpxchg指令完成原子操作

#### 2.CAS存在的问题

- CAS实现原子操作的三大问题  

- - ABA问题：因为CAS需要在操作值的时候检查值有没有发生变化，如果没有发生变化则更新，如果A->B->A,那么CAS检查时会认为值没有发生变化，但是实际上却变化了；

  - - 解决办法：在变量前面追加版本号;变成1A->2B->3A

  - 循环时间长开销大：自旋CAS对CPU开销大

  - 只能保证一个共享变量的原子操作，多个共享变量操作时CAS无法保证操作的原子性；

  - - 解决办法：用锁；或者将多个共享变量合并成一个共享变量

#### 3.CAS实现: ActomicInteger

















