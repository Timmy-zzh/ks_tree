#### 1.网络下载apk后，点击安装

- 网络下载好的apk文件通常存放在sd卡中，当点击会弹出一个系统界面只是我们进行安装操作，这个界面是一个Activity - PackageInstallAcitivity.java,当点击安装后，最终会将所安装的apk信息通过PackageInstallSession传给PMS，最后调用PMS的installStage()方法

~~~java
public class PackageInstallerSession extends IPackageInstallerSession.Stub {
    private void commitLocked() throws PackageManagerException {
        mPm.installStage(mPackageName, stageDir, localObserver, params,
                mInstallerPackageName, mInstallerUid, user, mSigningDetails);
    }
}
~~~

#### PMS.installStage()

~~~java
public class PackageManagerService extends IPackageManager.Stub {

    void installStage(String packageName, File stagedDir,
            IPackageInstallObserver2 observer, PackageInstaller.SessionParams sessionParams,
            String installerPackageName, int installerUid, UserHandle user,
            PackageParser.SigningDetails signingDetails) {
        final VerificationInfo verificationInfo = new VerificationInfo(
                sessionParams.originatingUri, sessionParams.referrerUri,
                sessionParams.originatingUid, installerUid);

        final OriginInfo origin = OriginInfo.fromStagedFile(stagedDir);

        final Message msg = mHandler.obtainMessage(INIT_COPY);
        final int installReason = fixUpInstallReason(installerPackageName, installerUid,
                sessionParams.installReason);
      // 初始化InstallParams对象
        final InstallParams params = new InstallParams(origin, null, observer,
                sessionParams.installFlags, installerPackageName, sessionParams.volumeUuid,
                verificationInfo, user, sessionParams.abiOverride,
                sessionParams.grantedRuntimePermissions, signingDetails, installReason);
      params.setTraceMethod("installStage")
        .setTraceCookie(System.identityHashCode(params));
      // 将params设置给Message，并使用Handler发送INIT_COPY消息
        msg.obj = params;
        mHandler.sendMessage(msg);
    }
}
~~~



































