#### 1.Class字节码由来

- Java能够实现“一次编译，到处运行”，其中class文件要占大部分功劳。
  - 为了让Java语言具有良好的跨平台能力，Java提供了一种可以在所有平台上都能使用的一种中间代码-字节码类文件(.class文件)
  - 有了字节码，无论哪种平台（Mac，Windows，Linux等），只要安装了虚拟机都可以直接运行字节码

- 有了字节码，也解除了Java虚拟机和Java语言之间的耦合
  - Java虚拟机也支持很多除Java语言以外的其他语言，如Groovy，JRuby，Jython，Scala等，因为这些语言经过编译之后也可以生成能够被JVM解析并执行的字节码文件。
- 虚拟机不关系字节码是由那种语言编译而来的。

<img src=".\res1\1.字节码与虚拟机解耦.png" alt="1.字节码与虚拟机解耦" style="zoom:80%;" />

#### 2.class文件组成

**class文件里只有两种数据结构：无符号数和表**

- 无符号数：属于基本的数据类型
  - 以u1，u2，u4，u8。来分别代表1个字节，2个字节，4个字节和8个字节的无符号数，
  - 无符号数可以用来描述数字，索引引用，数量值或者字符串
- 表：
  - 表是由多个无符号数或者其他表作为数据项构成的复合数据类型。
  - class文件中所有的表都以"_info"结尾，整个class文件本质上就是一张表。

表和无符号数之间的关系：

<img src=".\res1\2.表和无符号数之间的关系.png" alt="2.表和无符号数之间的关系" style="zoom:80%;" />

伪代码如下：

~~~java
// 无符号数
u1 = byte[1];
u2 = byte[2];
u4 = byte[4];
u8 = byte[8];

// 表
class_table {
    // 表中可以引用各种无符号数，
    u1 tag;
    u2 index2;
    ...
    // 表中也可以引用其它表
    method_table mt;
    ...
}
~~~

#### 3.class文件结构

- class文件中只存在无符号数和表两种数据结构。
  - 这些无符号数和表组成了class中的各个结构；
  - 这些结构按照**预先规定好的顺序**紧密的从前向后排列，相邻的项之间没有任何间隙。

- class文件结构

| 魔数 | 版本号 | 常量池 | 访问标志 | 类/父类/接口 | 字段描述集合 | 方法描述集合 | 属性描述集合 |
| ---- | ------ | ------ | -------- | ------------ | ------------ | ------------ | ------------ |
|      |        |        |          |              |              |              |              |

当JVM加载某个class文件时，jvm就是根据上图中的结构去解析class文件，加载class文件到内存中，并在内存中分配相应的空间。具体某一种结构需要占用多大空间，如下图：

|        字段         |       名称       |    数据类型    |         数量          |
| :-----------------: | :--------------: | :------------: | :-------------------: |
|    magic number     |       魔数       |       u4       |           1           |
|    major version    |     主版本号     |       u2       |           1           |
|    minor version    |     副版本号     |       u2       |           1           |
| constant_pool_count |    常量池大小    |       u2       |           1           |
|    constant_pool    |      常量池      |    cp_info     | constant_pool_count-1 |
|     access_flag     |     访问标志     |       u2       |           1           |
|     this_class      |    当前类索引    |       u2       |           1           |
|     super_class     |     父类索引     |       u2       |           1           |
|  interfaces_count   | 接口索引集合大小 |       u2       |           1           |
|     interfaces      |   接口索引集合   |       u2       |   interfaces_count    |
|    fields_count     | 字段索引集合大小 |       u2       |           1           |
|       fields        |   字段索引集合   |   field_info   |     fields_count      |
|    methods_count    | 方法索引集合大小 |       u2       |           1           |
|       methods       |   方法索引集合   |  method_info   |     methods_count     |
|  attributes_count   | 属性索引集合大小 |       u2       |           1           |
|     attributes      |   属性索引集合   | attribute_info |   attributes_count    |

- 无符号数，表，class结构关系
  - class文件中的无符号和表相当于人类身体中的H，O，C，N等元素
  - 而class结构图中的各项结果相当于人类身体的各个器官
  - 并且这些器官的组织顺序是有严格顺序要求的

#### 4.实例分析

~~~java
import java.io.Serializable;

public class Test implements Serializable, Cloneable {

    private int num = 1;
    public int add(int i) {
        int j = 10;
        num = num + i;
        return num;
    }
}
~~~

- 通过javac编译，生成Test.class字节码，然后使用16进制编辑器打开class文件，查看内容
  - 下图中都是一些16进制数字，每两个字符代表一个字节

<img src=".\res1\3.class内存(16进制).png" alt="3.class内存(16进制)" style="zoom:100%;" />

##### 魔数 magic number

~~~~java
CA FE BA BE
~~~~

- class文件开头的四个字节时class文件的魔数，它是一个固定的值--0XCAFEBABE
- 魔数是class文件的标志，是判断一个文件是不是class格式文件的标准，如果开头四个字节不是0XCAFEBABE，就说明不是class文件，不能被JVM识别或加载

##### 版本号



































